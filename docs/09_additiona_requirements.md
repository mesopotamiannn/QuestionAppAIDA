# 要件定義 追記版（カテゴリ複数選択 / 18+カテゴリ追加 / テーマ切替 / 未選択=全カテゴリ）

本ドキュメントは既存要件定義に対する追記・変更点をまとめたものである。

---

## 1. 変更概要

### 追加・変更する内容
- カテゴリ選択UIを「プルダウン」から「複数選択ボタン（チップ）」に変更する
- カテゴリ未選択の場合は「全カテゴリから出題」とする（A案）
- 18+同意が成立した場合のみ「13番目カテゴリ（大人の質問/18+）」を表示する
- 18+モード有効時、UIカラーテーマをピンク系（adultテーマ）へ切り替える

---

## 2. 機能要件（追記）

### 2.1 カテゴリ選択UI（複数選択チップ）

#### 要件
- カテゴリはボタン（チップ）で表示し、ユーザーは複数選択できる
- 「すべて」「クリア」操作を提供する
- 選択状態はトグル（押すと選択/解除）で管理する

#### 操作仕様
- すべて：表示中のカテゴリを全選択する
- クリア：選択状態を空にする
- チップ：押下で選択/解除

#### 表示カテゴリ
- 通常は12カテゴリを表示
- 18+同意済みの場合のみ、追加で13番目カテゴリ（大人の質問/18+）を表示する（詳細は2.2）

---

### 2.2 カテゴリ未選択の扱い（A案）

#### 要件
- カテゴリ選択が「未選択（空配列）」の場合、**全カテゴリから出題**する
- ユーザーに対して「未選択＝全カテゴリ」の補足文言を表示する

#### 補足文言例
- 「※未選択の場合は全カテゴリから出題」

---

### 2.3 18+カテゴリ（13番目カテゴリ）の追加表示

#### 目的
- アダルト（18+）に該当する質問を通常質問と明確に分離し、同意のないユーザーに露出しない

#### 要件
- 18+同意が成立（adultEnabled=true）した場合のみ以下を実施する
  - カテゴリ一覧の末尾に **13番目カテゴリ** を表示する
  - 13番目カテゴリを選択できる
- adultEnabled=false の場合は以下を実施する
  - 13番目カテゴリを表示しない
  - 13番目カテゴリが選択済みであれば自動解除する

#### 13番目カテゴリ定義（例）
- id: `adult`
- name: `大人の質問（18+）`
- rating: `adult`

---

### 2.4 18+同意フロー（再掲＋UI連動の追記）

#### 要件
- 18+ボタン（トグル）を押下した際、次のフローを必ず表示する
  1) 年齢確認（18歳以上か）
  2) 注意喚起（相手への配慮・同意・嫌がったら即中止・スキップ可）
  3) 同意後に adultEnabled=true とする

#### UI連動
- adultEnabled=true になった場合のみ
  - 13番目カテゴリが表示される
  - テーマが adult（ピンク系）に切り替わる（詳細は2.5）
  - adult質問データが未取得なら取得し、IndexedDBに保存する

---

### 2.5 テーマ切替（adultテーマ：ピンク系）

#### 目的
- 18+モードを視覚的にも明確化し、誤操作や誤認を防ぐ

#### 要件
- テーマは `default` と `adult` の2種類とする
- adultEnabled=true の場合、UIのアクセントカラー等をピンク系へ変更する
- adultEnabled=false の場合、defaultテーマへ戻す

#### 実装方式（指定）
- Vanilla CSSのCSS変数を用いる
- `<html data-theme="...">` によりテーマを切り替える
  - `data-theme="default"`
  - `data-theme="adult"`

---

## 3. 出題ロジック要件（追記）

### 3.1 出題対象の決定（カテゴリ・18+）

#### 要件
- カテゴリ未選択（空）の場合：
  - `general` の全カテゴリを候補とする
- カテゴリ選択ありの場合：
  - 選択された `general` カテゴリ群を候補とする

#### 18+混入条件（事故防止ルール）
- `adultEnabled=true` であっても **自動でadult質問は混ぜない**
- `adult` カテゴリ（13番目カテゴリ）が **明示的に選択された場合のみ**
  - `adult` 質問（rating=adult）を候補に追加する

---

## 4. データ要件（追記）

### 4.1 カテゴリデータ
- 12カテゴリ（general）
- 13番目カテゴリ（adult）は同意済みの場合のみUIに追加される

### 4.2 クライアント状態
- `adultEnabled`（boolean）
  - localStorage等に保存し、起動時に復元する
- `selectedCategoryIds`（string[]）
  - 未選択＝全カテゴリとして扱う

---

## 5. 受け入れ条件（追加）

### カテゴリUI
- [ ] チップで複数選択できる
- [ ] すべて/クリアが動作する
- [ ] 未選択時に全カテゴリ出題になる
- [ ] 補足文言「未選択＝全カテゴリ」が表示される

### 18+カテゴリ
- [ ] 18+同意前は13番目カテゴリが表示されない
- [ ] 18+同意後に13番目カテゴリが表示される
- [ ] 18+をOFFにすると13番目カテゴリが消え、選択状態も解除される

### テーマ切替
- [ ] 18+同意後、UIのアクセントカラーがピンク系に変化する
- [ ] 18+OFFでdefaultテーマに戻る

### 出題ロジック
- [ ] 18+ONでも、adultカテゴリ未選択ならadult質問が混ざらない
- [ ] adultカテゴリを選択した場合のみadult質問が候補に含まれる

# 要件定義 追記版（Deepワンクッション / 👍いいね集計 / 名前自動補完）

本ドキュメントは既存要件定義に対する追記・変更点（Deep前ワンクッションUI、👍いいね（D1集計）、名前未入力時の自動補完）をまとめたものである。

---

## 1. 変更概要

### 追加する内容
- Deep質問に入る直前に「ワンクッションUI（注意喚起）」を挿入する
- 質問に「👍いいね」ボタンを追加し、サーバ（D1）で集計可能にする
- 参加者名が未入力の場合、デフォルト名（Aさん/Bさん または 1さん/2さん…）を自動補完する

---

## 2. 機能要件（追記）

### 2.1 Deep前ワンクッションUI

#### 目的
- 深い質問への移行を丁寧にし、心理的安全性を確保する
- 「無理に答えなくてよい」「スキップできる」「相手への配慮」を明示して事故を減らす

#### 表示タイミング
- セッション内で初めてDeep質問に到達する直前（deep開始点）に1回だけ表示する
- Deep質問が存在しない場合は表示しない

#### UI仕様
- 形式：フルスクリーンまたはモーダルのインタースティシャル
- 表示内容（必須）：
  - タイトル：例「ここから少し深い質問です」
  - 本文：
    - 無理に答えなくてOK
    - 言いにくければスキップOK
    - 相手が嫌がったら別の話題に切り替える
- ボタン（必須）：
  - 「OK、進む」
- ボタン（任意・推奨）：
  - 「Deepはスキップして通常に戻す」または「Deepをスキップして終了へ」

#### Deep開始点の決め方
- 質問セット生成時に深さ配列（light → normal → deep）を確定し、deep開始indexを保持する
- deep開始index到達時にワンクッションUIを出す

---

### 2.2 👍いいね（D1集計）

#### 目的
- 「盛り上がった/話しやすかった」質問を収集し、将来的に人気質問の抽出・おすすめ作成に利用する
- ネガティブ評価（👎）は空気を壊すため導入しない

#### UI仕様
- 各質問カードに 👍ボタンを表示
- 1人（1端末）につき、同一質問に対するいいねは最大1回
- 取り消し（unlike）は任意（実装する場合は同様に1回取り消し可能）
- いいね数は小さく表示し、質問体験の主役にならないようにする

#### クライアント識別（ログインなし前提）
- `clientId` を初回起動時にUUID生成し、localStorageに保存する
- API送信時に `clientId` を付与して重複いいねを防ぐ

#### API要件（例）
- `POST /api/questions/:id/like`
  - body: `{ clientId: string }`
  - 既に同一(questionId, clientId)が存在する場合は重複として無視（成功扱い）
- `DELETE /api/questions/:id/like`（任意）
  - body: `{ clientId: string }`
- `GET /api/questions/:id/like-count`（任意）
  - いいね数を返す
- `GET /api/questions/top?categoryId=...`（将来）
  - いいね数上位を返す

#### D1テーブル要件（案）
- `question_likes`
  - `question_id` TEXT NOT NULL
  - `client_id` TEXT NOT NULL
  - `created_at` INTEGER NOT NULL
  - PRIMARY KEY (`question_id`, `client_id`)
  - INDEX（任意）：`question_id` 単体

※ 初期は `questions` テーブルに like_count を持たず、集計クエリで対応してよい。
（アクセス増で重くなった場合に like_count を導入し、更新で最適化する）

---

### 2.3 名前未入力時の自動補完

#### 目的
- 初回体験の摩擦（入力必須による離脱）を減らす
- 合コンなど急いで開始したい場面でもスムーズに進行できる

#### 要件
- 参加者名入力は必須としない
- 未入力（空欄/空白のみ）の参加者にはデフォルト名を自動付与する
- デフォルト名は一意であること

#### デフォルト名の仕様（推奨）
- 参加人数が2人のとき：
  - `Aさん`, `Bさん`
- 参加人数が3人以上のとき：
  - `1さん`, `2さん`, `3さん` ...（人数分）

※ デフォルト名はUI表示用。ユーザーは後から任意で編集可能。

#### 受け入れ条件
- 全員未入力でもセッション開始できる
- 自動補完された名前が「回答者表示」「順番表示」に正しく反映される

---

## 3. 受け入れ条件（追加）

### DeepワンクッションUI
- [ ] Deep質問を含むセッションで、Deep開始直前にワンクッションUIが1回だけ表示される
- [ ] 「OK、進む」でDeep質問に遷移できる
- [ ] （任意）「Deepをスキップ」導線が機能する

### 👍いいね
- [ ] 質問カードから👍できる
- [ ] 同一端末で同一質問に複数回👍できない（重複は無視される）
- [ ] D1にいいねが保存され、集計可能である

### 名前自動補完
- [ ] 名前未入力でもセッション開始できる
- [ ] 2人はAさん/Bさん、3人以上は1さん/2さん…で自動補完される
- [ ] 自動補完名がセッション中の表示に反映される
